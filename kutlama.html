let soundEnabled = true;

function playBoom() {
    if (!soundEnabled) return;

    const audio = new (window.AudioContext || window.webkitAudioContext)();

    /* ============================================
       1) STEREO PANNER — 3D efekti için
    ============================================ */
    const panner = audio.createStereoPanner();
    // Patlama her seferinde hafif farklı bir konumdan gelir
    panner.pan.value = (Math.random() * 2 - 1) * 0.8; // -0.8 ile 0.8 arası


    /* ============================================
       2) TOK BASS PATLAMASI (Ana BOOM çekirdeği)
    ============================================ */
    const osc = audio.createOscillator();
    const gain = audio.createGain();

    osc.type = "sine";
    osc.frequency.setValueAtTime(70, audio.currentTime);
    osc.frequency.exponentialRampToValueAtTime(22, audio.currentTime + 0.5);

    gain.gain.setValueAtTime(3.0, audio.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audio.currentTime + 0.6);

    osc.connect(gain).connect(panner).connect(audio.destination);

    osc.start();
    osc.stop(audio.currentTime + 0.6);


    /* ============================================
       3) BÜYÜK GÜRÜLTÜ PATLAMASI (Havai fişek genişliği)
    ============================================ */
    const bufferSize = 2 * audio.sampleRate;
    const noiseBuffer = audio.createBuffer(2, bufferSize, audio.sampleRate);

    // L/R kanallarına farklı gürültü veriyoruz (3D genişlik)
    for (let ch = 0; ch < 2; ch++) {
        const output = noiseBuffer.getChannelData(ch);
        for (let i = 0; i < bufferSize; i++) {
            output[i] = (Math.random() * 2 - 1) *
                         (1 - i / bufferSize) *
                         1.3;
        }
    }

    const noise = audio.createBufferSource();
    noise.buffer = noiseBuffer;

    // Hafif genişleme için gain
    const noiseGain = audio.createGain();
    noiseGain.gain.setValueAtTime(2.0, audio.currentTime);
    noiseGain.gain.exponentialRampToValueAtTime(0.001, audio.currentTime + 1.2);

    noise.connect(noiseGain).connect(panner).connect(audio.destination);

    noise.start();
    noise.stop(audio.currentTime + 1.3);


    /* ============================================
       4) PATLAMA ANINDA "PUNCH" — şok etkisi
    ============================================ */
    const punchOsc = audio.createOscillator();
    const punchGain = audio.createGain();

    punchOsc.type = "square";
    punchOsc.frequency.setValueAtTime(220, audio.currentTime);

    punchGain.gain.setValueAtTime(1.2, audio.currentTime);
    punchGain.gain.exponentialRampToValueAtTime(0.001, audio.currentTime + 0.15);

    punchOsc.connect(punchGain).connect(panner).connect(audio.destination);

    punchOsc.start();
    punchOsc.stop(audio.currentTime + 0.15);


    /* ============================================
       5) UZUN YANKI (REVERB BENZERİ KUYRUK)
    ============================================ */
    const reverbBufferSize = audio.sampleRate * 1.5; // ~1.5 sn reverb
    const reverbBuffer = audio.createBuffer(2, reverbBufferSize, audio.sampleRate);

    for (let ch = 0; ch < 2; ch++) {
        const channelData = reverbBuffer.getChannelData(ch);
        for (let i = 0; i < reverbBufferSize; i++) {
            channelData[i] =
                (Math.random() * 2 - 1) * // random
                Math.pow(1 - i / reverbBufferSize, 2) * // daha uzun ve yumuşak decay
                0.4; // yankı seviyesi
        }
    }

    const reverb = audio.createBufferSource();
    reverb.buffer = reverbBuffer;

    const reverbGain = audio.createGain();
    reverbGain.gain.setValueAtTime(0.6, audio.currentTime);
    reverbGain.gain.exponentialRampToValueAtTime(0.001, audio.currentTime + 1.5);

    reverb.connect(reverbGain).connect(panner).connect(audio.destination);

    reverb.start();
    reverb.stop(audio.currentTime + 1.5);
}
